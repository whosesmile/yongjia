tinymce.PluginManager.add('upload', function (editor, url) {

  function upload() {
    // 获取angular句柄
    var injector = angular.element(document.body).injector();

    injector.get('$modal').open({
      templateUrl: 'config/templates/upload.tinymce.html',
      controller: function ($scope, $upload, growl) {
        $scope.onFileSelect = function ($files) {
          // $files: an array of files selected, each file has name, size, and type.
          for (var i = 0; i < $files.length; i++) {
            var file = $files[i];
            $scope.upload = $upload.upload({
              url: '/web/uploadPic',
              method: 'POST',
              file: file
            }).then(function (res) {
              growl.addSuccessMessage('上传成功');
              tinymce.EditorManager.activeEditor.insertContent('<img src="' + res.entity + '" />');
            }, function (rej) {
              growl.addErrorMessage(rej.message || '上传失败');
            }, function (e) {
              growl.addInfoMessage('正在上传：' + parseInt(100.0 * e.loaded / e.total, 10));
            });
          }
          // 关闭弹窗
          $scope.$close();
        };
      }
    });
  }

  // Add a button that opens a window
  editor.addButton('upload', {
    tooltip: '上传图片',
    icon: 'image',
    onclick: upload
  });
});